rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Colección de balizas - Las balizas pueden auto-registrarse y leer/actualizar
    match /beacons/{beaconId} {
      // Las balizas pueden leer su configuración
      allow read: if true;
      
      // Las balizas pueden crear su propio documento al conectarse por primera vez
      // con campos mínimos (beaconId, lastSeen, online)
      allow create: if request.resource.data.beaconId == beaconId
        && request.resource.data.keys().hasAll(['beaconId', 'lastSeen', 'online']);
      
      // Las balizas pueden actualizar solo campos de heartbeat
      // El panel puede actualizar todo
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['lastSeen', 'online']) || request.auth != null;
      
      // Solo usuarios autenticados pueden eliminar
      allow delete: if request.auth != null;
      
      // Usuarios autenticados tienen acceso completo
      allow write: if request.auth != null;
    }
    
    // Colección de logs de emergencia - Solo usuarios autenticados
    match /emergency_logs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false; // Los logs no se modifican
    }
    
    // Cualquier otra colección requiere autenticación
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}